<!DOCTYPE html>
<html>
<head>
  <title>Home</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, button {
      margin: 5px;
      padding: 8px;
    }
    #companiesList div {
      margin-bottom: 6px;
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h2>Welcome, <span id="userName"></span></h2>

  <!-- View Companies Button -->
  <button id="viewCompaniesBtn">View All Companies</button>
  <div id="companiesList"></div>

  <hr>

  <!-- Add Company Form -->
  <h3>Add New Company</h3>
  <form id="addCompanyForm">
    <input type="text" id="ticker_symbol" placeholder="Ticker Symbol" required />
    <input type="text" id="company_name" placeholder="Company Name" required />
    <input type="text" id="sector" placeholder="Sector" />
    <input type="number" step="0.01" id="stock_price" placeholder="Stock Price" required />
    <input type="number" id="market_cap" placeholder="Market Cap" required />
    <button type="submit">Add Company</button>
  </form>

  <script>
    window.onload = function () {
      // Show user name from localStorage
      document.getElementById('userName').textContent = localStorage.getItem('name') || 'Guest';

      // View Companies
      document.getElementById('viewCompaniesBtn').addEventListener('click', async () => {
        try {
          const res = await fetch('/api/companies');
          if (!res.ok) throw new Error("Failed to fetch companies");

          const companies = await res.json();
          const listDiv = document.getElementById('companiesList');
          listDiv.innerHTML = '<h4>Companies:</h4>';

          if (companies.length === 0) {
            listDiv.innerHTML += '<p>No companies found.</p>';
            return;
          }

          companies.forEach(c => {
            listDiv.innerHTML += `
              <div>
                <strong>${c.ticker_symbol}</strong> - ${c.company_name} (${c.sector || "N/A"})<br>
                â‚¹${c.stock_price} | Market Cap: ${c.market_cap}
              </div>`;
          });
        } catch (error) {
          console.error(error);
          alert("Unable to fetch companies. Please try again.");
        }
      });

      // Add Company
      document.getElementById('addCompanyForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
          ticker_symbol: document.getElementById('ticker_symbol').value,
          company_name: document.getElementById('company_name').value,
          sector: document.getElementById('sector').value,
          stock_price: parseFloat(document.getElementById('stock_price').value),
          market_cap: parseInt(document.getElementById('market_cap').value),
        };

        try {
          const res = await fetch('/api/companies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (res.ok) {
            alert('Company added successfully!');
            document.getElementById('addCompanyForm').reset();
          } else {
            const msg = await res.text();
            alert('Error: ' + msg);
          }
        } catch (err) {
          console.error(err);
          alert('Failed to add company.');
        }
      });
    };
  </script>
</body>
</html>
